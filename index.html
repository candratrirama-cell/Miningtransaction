<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mining Coffee - Cloud System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f1f5f9; font-family: 'Inter', sans-serif; }
        .menu-card { transition: all 0.2s ease; cursor: pointer; border: 1px solid #e2e8f0; }
        .menu-card:active { transform: scale(0.95); background-color: #eff6ff; }
        .stats-card { background: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
    </style>
</head>
<body class="pb-10">

    <div id="paymentModal" class="modal">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full mx-4 border border-gray-100">
            <h3 class="text-xl font-black text-center mb-2 uppercase italic tracking-tighter text-gray-800">Metode Bayar</h3>
            <p id="selectedItemName" class="text-center text-blue-600 font-bold mb-6 italic text-sm"></p>
            <div class="grid grid-cols-1 gap-4">
                <button onclick="confirmSale('CASH')" class="bg-green-500 text-white py-4 rounded-2xl font-black text-lg hover:bg-green-600 shadow-lg shadow-green-100 transition">ðŸ’µ CASH</button>
                <button onclick="confirmSale('QRIS')" class="bg-blue-600 text-white py-4 rounded-2xl font-black text-lg hover:bg-blue-700 shadow-lg shadow-blue-100 transition">ðŸ“± QRIS</button>
                <button onclick="closeModal()" class="mt-2 text-gray-400 font-bold text-xs tracking-widest uppercase">Batal</button>
            </div>
        </div>
    </div>

    <div id="loader" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-600 mb-4"></div>
        <p class="text-gray-500 font-bold italic tracking-widest uppercase text-xs text-center">Mining Coffee Cloud<br>PT Bangga Karya Indonesia</p>
    </div>

    <div class="max-w-6xl mx-auto px-4 pt-8">
        <header class="flex flex-col md:flex-row md:justify-between md:items-end mb-8 gap-4">
            <div>
                <h1 class="text-4xl font-black text-gray-900 italic tracking-tighter uppercase">Mining Coffee</h1>
                <p class="text-blue-600 font-bold text-[10px] tracking-[0.4em] uppercase">PT Bangga Karya Indonesia</p>
            </div>
            <div class="flex flex-wrap gap-2">
                <input type="file" id="csvInput" accept=".csv" class="hidden">
                <button onclick="document.getElementById('csvInput').click()" class="bg-white text-gray-700 border border-gray-200 px-4 py-2 rounded-xl text-[10px] font-black hover:bg-gray-50 transition uppercase">Upload Data</button>
                <button id="btnExport" class="bg-gray-800 text-white px-4 py-2 rounded-xl text-[10px] font-black hover:bg-black transition uppercase">Export (.CSV)</button>
                <button id="btnReset" class="bg-red-50 text-red-600 px-4 py-2 rounded-xl text-[10px] font-black border border-red-100 uppercase">Reset</button>
            </div>
        </header>

        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-10 text-center md:text-left">
            <div class="stats-card p-5 border-l-4 border-blue-500">
                <p class="text-[9px] font-black text-gray-400 uppercase tracking-widest mb-1">Omzet Hari Ini</p>
                <p id="today-revenue" class="text-xl font-black text-gray-800">Rp 0</p>
            </div>
            <div class="stats-card p-5 border-l-4 border-green-500">
                <p class="text-[9px] font-black text-gray-400 uppercase tracking-widest mb-1">Laba Hari Ini</p>
                <p id="today-profit" class="text-xl font-black text-green-600">Rp 0</p>
            </div>
            <div class="stats-card p-5 border-l-4 border-purple-600">
                <p class="text-[9px] font-black text-gray-400 uppercase tracking-widest mb-1">Omzet Bulan Ini</p>
                <p id="month-revenue" class="text-xl font-black text-gray-800">Rp 0</p>
            </div>
            <div class="stats-card p-5 border-l-4 border-orange-500">
                <p class="text-[9px] font-black text-gray-400 uppercase tracking-widest mb-1">Laba Bulan Ini</p>
                <p id="month-profit" class="text-xl font-black text-orange-600">Rp 0</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2">
                <h2 class="text-xl font-black mb-6 text-gray-800 flex items-center italic uppercase tracking-tighter">
                    <span class="bg-blue-600 w-3 h-3 rounded-full mr-3"></span> Daftar Menu
                </h2>
                <div id="menu-container" class="grid grid-cols-2 sm:grid-cols-3 gap-4"></div>
            </div>

            <div class="bg-white p-6 rounded-3xl shadow-xl h-fit sticky top-6">
                <h2 class="text-lg font-black mb-6 text-gray-800 border-b pb-4 uppercase italic">Ringkasan Hari Ini</h2>
                <div id="sales-list" class="space-y-3 min-h-[200px]"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, remove, query, orderByChild, equalTo, limitToLast, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAElBpBUj78ii_t-AKSfGr2FwKIKdC3PUs",
            authDomain: "miningtransaksi.firebaseapp.com",
            databaseURL: "https://miningtransaksi-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "miningtransaksi",
            storageBucket: "miningtransaksi.firebasestorage.app",
            messagingSenderId: "891158052466",
            appId: "1:891158052466:web:562d2cc72d2f741d23cceb"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // DATA MENU LENGKAP DENGAN HPP & LABA
        const products = [
            { id: 1, name: "Americano", hj: 7000, hpp: 4700, laba: 2300 },
            { id: 2, name: "Mining Kopi Susu", hj: 8000, hpp: 5900, laba: 2100 },
            { id: 3, name: "Kopi Susu Gula Aren", hj: 12000, hpp: 7400, laba: 4600 },
            { id: 4, name: "Kopi Susu Pandan", hj: 12000, hpp: 7900, laba: 4100 },
            { id: 5, name: "Caramel Latte", hj: 13000, hpp: 7900, laba: 5100 },
            { id: 6, name: "Matcha / Chocolate", hj: 10000, hpp: 6400, laba: 3600 },
            { id: 7, name: "Mining Milo", hj: 10000, hpp: 6800, laba: 3200 }
        ];

        let pendingProduct = null;
        window.openModal = (p) => { pendingProduct = p; document.getElementById('selectedItemName').innerText = p.name; document.getElementById('paymentModal').style.display = 'flex'; };
        window.closeModal = () => { document.getElementById('paymentModal').style.display = 'none'; pendingProduct = null; };
        
        window.confirmSale = (method) => {
            if (!pendingProduct) return;
            const now = new Date();
            push(ref(db, 'sales'), {
                name: pendingProduct.name,
                hj: pendingProduct.hj,
                hpp: pendingProduct.hpp,
                laba: pendingProduct.laba,
                payment: method,
                dateStr: now.toLocaleDateString('en-CA'),
                monthStr: `${now.getMonth() + 1}-${now.getFullYear()}`,
                timestamp: now.getTime()
            });
            closeModal();
        };

        const menuContainer = document.getElementById('menu-container');
        products.forEach(p => {
            const btn = document.createElement('div');
            btn.className = "menu-card bg-white p-5 rounded-2xl shadow-sm flex flex-col items-start border-gray-100 border";
            btn.innerHTML = `
                <span class="text-[9px] font-black text-blue-500 uppercase mb-1 tracking-widest">Mining Coffee</span>
                <span class="font-bold text-gray-800 text-sm leading-tight mb-3 h-8">${p.name}</span>
                <span class="text-[10px] font-black text-gray-900 bg-gray-50 px-2 py-1 rounded italic border border-gray-200">Rp ${p.hj.toLocaleString()}</span>
            `;
            btn.onclick = () => openModal(p);
            menuContainer.appendChild(btn);
        });

        // IMPORT CSV LOGIC
        document.getElementById('csvInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(event) {
                const text = event.target.result;
                const rows = text.split('\n').slice(1);
                let count = 0;
                rows.forEach(row => {
                    const cols = row.split(',');
                    if(cols.length >= 5) {
                        push(ref(db, 'sales'), {
                            name: cols[0].replace(/"/g, ''),
                            payment: cols[1].replace(/"/g, '') || "CASH",
                            hj: parseInt(cols[2]) || 0,
                            hpp: parseInt(cols[3]) || 0,
                            laba: parseInt(cols[4]) || 0,
                            dateStr: cols[5] ? cols[5].trim() : new Date().toLocaleDateString('en-CA'),
                            monthStr: cols[5] ? `${new Date(cols[5]).getMonth()+1}-${new Date(cols[5]).getFullYear()}` : "1-2026",
                            timestamp: new Date().getTime()
                        });
                        count++;
                    }
                });
                alert(`Berhasil mengunggah ${count} data!`);
            };
            reader.readAsText(file);
        });

        // SYNC REALTIME
        onValue(ref(db, 'sales'), (snapshot) => {
            document.getElementById('loader').style.display = 'none';
            const data = snapshot.val() ? Object.values(snapshot.val()) : [];
            const now = new Date();
            const today = now.toLocaleDateString('en-CA');
            const thisMonth = `${now.getMonth() + 1}-${now.getFullYear()}`;
            let tRev = 0, tLaba = 0, mRev = 0, mLaba = 0;
            let summary = {};

            data.forEach(s => {
                if(s.monthStr === thisMonth) { mRev += s.hj; mLaba += (s.laba || 0); }
                if(s.dateStr === today) {
                    tRev += s.hj; tLaba += (s.laba || 0);
                    const key = `${s.name} (${s.payment})`;
                    summary[key] = (summary[key] || 0) + 1;
                }
            });

            document.getElementById('today-revenue').innerText = `Rp ${tRev.toLocaleString()}`;
            document.getElementById('today-profit').innerText = `Rp ${tLaba.toLocaleString()}`;
            document.getElementById('month-revenue').innerText = `Rp ${mRev.toLocaleString()}`;
            document.getElementById('month-profit').innerText = `Rp ${mLaba.toLocaleString()}`;

            const listHtml = Object.entries(summary).map(([key, qty]) => `
                <div class="flex justify-between items-center bg-white p-4 rounded-2xl border border-gray-100 shadow-sm">
                    <div class="flex flex-col">
                        <span class="font-bold text-gray-800 text-xs">${key.split(' (')[0]}</span>
                        <span class="text-[9px] font-black ${key.includes('CASH') ? 'text-green-500' : 'text-blue-500'} italic uppercase">${key.includes('CASH') ? 'ðŸ’µ CASH' : 'ðŸ“± QRIS'}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="bg-gray-800 text-white px-3 py-1 rounded-lg font-black text-[10px]">x${qty}</span>
                        <button class="btnDelete text-red-300 hover:text-red-500" data-name-payment="${key}">
                            <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"/></svg>
                        </button>
                    </div>
                </div>
            `).join('');
            document.getElementById('sales-list').innerHTML = listHtml || '<p class="text-center text-gray-300 py-10 italic text-[10px] uppercase font-bold tracking-widest">Kosong</p>';

            document.querySelectorAll('.btnDelete').forEach(btn => {
                btn.onclick = () => {
                    const fullKey = btn.getAttribute('data-name-payment');
                    const name = fullKey.split(' (')[0];
                    const method = fullKey.includes('CASH') ? 'CASH' : 'QRIS';
                    const q = query(ref(db, 'sales'), orderByChild('name'), equalTo(name), limitToLast(20));
                    get(q).then(snap => {
                        let del = false; snap.forEach(c => { if(!del && c.val().payment === method && c.val().dateStr === today) { remove(c.ref); del = true; } });
                    });
                };
            });
        });

        document.getElementById('btnExport').onclick = () => {
            get(ref(db, 'sales')).then(snap => {
                const data = snap.val(); if(!data) return alert("Data Kosong");
                let csv = "Produk,Metode,Harga Jual,HPP,Laba,Tanggal\n" + Object.values(data).map(s => `"${s.name}","${s.payment}",${s.hj},${s.hpp || 0},${s.laba || 0},${s.dateStr}`).join("\n");
                const blob = new Blob([csv], {type: 'text/csv'});
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Laporan_MiningCoffee.csv`; a.click();
            });
        };

        document.getElementById('btnReset').onclick = () => {
            if(prompt("Password Admin PT BKI:") === "ADMIN") { if(confirm("Hapus semua data?")) remove(ref(db, 'sales')); }
        };
    </script>
</body>
</html>
